<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gārsecg</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #041E42;
      font-family: 'Arial', sans-serif;
    }

    canvas {
      display: block;
      background-attachment: fixed;
    }

    #healthDiv {
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: rgba(0, 0, 40, 0.7);
      color: #5CDBFF;
      padding: 10px 15px;
      font-family: 'Courier New', monospace;
      font-size: 20px;
      border-radius: 10px;
      border: 2px solid #5CDBFF;
      z-index: 1000;
      box-shadow: 0 0 10px #5CDBFF;
    }

    #gameTitle {
      position: fixed;
      top: 10px;
      left: 10px;
      color: #5CDBFF;
      font-family: 'Courier New', monospace;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 0 0 10px #5CDBFF;
      z-index: 1000;
    }

    /* Modal Styles */
    #modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    #modalContent {
      background: #041E42;
      padding: 20px;
      border: 2px solid #5CDBFF;
      border-radius: 10px;
      color: #5CDBFF;
      font-family: 'Courier New', monospace;
      text-align: center;
      width: 80%;
      max-width: 600px;
    }

    /* Existing button style */
    #modal button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background-color: #5CDBFF;
      color: #041E42;
    }

    /* New style for the fullscreen button */
    #fullscreenButton {
      background-color: orange;
      color: #041E42;
    }

    #gameTitle,
    #healthDiv {
      pointer-events: none;
      opacity: 0.7;
    }
  </style>
</head>

<body>
  <div id="gameTitle">Gārsecg (Alpha Version)</div>
  <div id="healthDiv">Health: 100% | Score: 0 | Dashes: 10</div>
  <canvas id="gameCanvas"></canvas>
  <!-- Modal Popup -->
  <div id="modal">
    <div id="modalContent">
      <h1>Welcome to Gārsecg</h1>
      <p>
        <strong>Instructions:</strong> Use WASD to move your submarine and your mouse to aim.
        Left click to shoot and right click (or Space) to dash.
      </p>
      <p>c will toggle the camera: follow ship or center game</p>
      <button id="fullscreenButton">Go Full Screen</button>
      <p>Survive as long as you can and score by destroying enemies!</p>
      <button id="beginButton">Begin</button>
    </div>
  </div>
  <script type="module">
    // Import explosion effects and enemy functions.
    import { startBubbleExplosion, updateBubbleExplosions } from "./bubbles.js";
    import { spawnGenericEnemy, updateAllEnemies } from "./enemies.js";
    import { startDamageExplosion, updateDamageExplosions } from './damageEffect.js';
    import { renderScene } from "./renderScene.js";
    import { updateAI } from "./ai.js";

    // Import Rapier2D (compat version) from Skypack.
    const shotSound = new Audio("shot.wav"); // Ensure this file exists
    import * as RAPIER from "https://cdn.skypack.dev/@dimforge/rapier2d-compat";
    await RAPIER.init();

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // --- High-DPI resolution-independent canvas setup ---
    function updateCanvasResolution() {
      const dpr = window.devicePixelRatio || 1;
      canvas.width = window.innerWidth * dpr;
      canvas.height = window.innerHeight * dpr;
      canvas.style.width = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.imageSmoothingEnabled = false;
    }
    updateCanvasResolution();
    window.addEventListener("resize", updateCanvasResolution);
    let lastDPR = window.devicePixelRatio || 1;
    setInterval(() => {
      const currentDPR = window.devicePixelRatio || 1;
      if (currentDPR !== lastDPR) {
        updateCanvasResolution();
        lastDPR = currentDPR;
      }
    }, 250);
    window.addEventListener("resize", () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });

    // Game world and constants.
    const worldWidth = 1920;
    const worldHeight = 1080;
    const playerRadius = 20;
    const enemyRadius = 15;
    const bulletRadius = 5;
    const maxPlayerSpeed = 400;
    const bulletSpeed = 1000;
    const bulletLifetime = 1000;
    let dashesLeft = 10;
    let playerHealth = 100;
    let score = 0;

    // Fire rate and dash control.
    const fireRate = 10;
    const fireInterval = 1000 / fireRate; // in milliseconds
    let lastShotTime = 0;
    let isShooting = false;
    // Global game variables (only for state tracking)
    let aiEnabled = false;
    let aiLeadFactor = 1.0;
    // These variables remain in the main file but will be managed via setter callbacks.
    let dashTriggered = false;
    let isDashing = false;
    const dashDuration = 1000; // Dash lasts for 1000ms (adjust as needed)
    let lastDashTime = -Infinity;
    // Declare accumulator for bullet timing
    let bulletAccumulator = 0;

    // Create Rapier2D physics world (no gravity).
    const gravity = { x: 0, y: 0 };
    const physicsWorld = new RAPIER.World(gravity);

    const eventQueue = new RAPIER.EventQueue(true);

    // --- Unified enemy and bullet arrays ---
    const enemies = [];
    const bullets = [];

    // --- Create Walls ---
    const walls = [];
    function createWall(x, y, width, height) {
      const bodyDesc = RAPIER.RigidBodyDesc.fixed().setTranslation(x, y);
      const wallBody = physicsWorld.createRigidBody(bodyDesc);
      const colliderDesc = RAPIER.ColliderDesc.cuboid(width / 2, height / 2);
      physicsWorld.createCollider(colliderDesc, wallBody);
      walls.push({ x, y, width, height });
    }
    function wallsFromObject(wallsObj) {
      if (wallsObj.walls && Array.isArray(wallsObj.walls)) {
        wallsObj.walls.forEach(wall => {
          // Assumes createWall(x, y, width, height) is defined in your game.
          createWall(wall.x, wall.y, wall.width, wall.height);
        });
      } else {
        console.error("Invalid walls data format.");
      }
    };
    wallsFromObject(
      {
  "walls": [
    {
      "x": 960,
      "y": 10,
      "width": 1880,
      "height": 20,
      "roomId": 1
    },
    {
      "x": 960,
      "y": 1070,
      "width": 1880,
      "height": 20,
      "roomId": 1
    },
    {
      "x": 10,
      "y": 540,
      "width": 20,
      "height": 1040,
      "roomId": 1
    },
    {
      "x": 1910,
      "y": 267.5,
      "width": 20,
      "height": 495,
      "roomId": 1
    },
    {
      "x": 1910,
      "y": 812.5,
      "width": 20,
      "height": 495,
      "roomId": 1
    },
    {
      "x": 2980,
      "y": 10,
      "width": 1880,
      "height": 20,
      "roomId": 2
    },
    {
      "x": 2497.5,
      "y": 1070,
      "width": 915,
      "height": 20,
      "roomId": 2
    },
    {
      "x": 3462.5,
      "y": 1070,
      "width": 915,
      "height": 20,
      "roomId": 2
    },
    {
      "x": 2030,
      "y": 267.5,
      "width": 20,
      "height": 495,
      "roomId": 2
    },
    {
      "x": 2030,
      "y": 812.5,
      "width": 20,
      "height": 495,
      "roomId": 2
    },
    {
      "x": 3930,
      "y": 540,
      "width": 20,
      "height": 1040,
      "roomId": 2
    },
    {
      "x": 2497.5,
      "y": 1190,
      "width": 915,
      "height": 20,
      "roomId": 3
    },
    {
      "x": 3462.5,
      "y": 1190,
      "width": 915,
      "height": 20,
      "roomId": 3
    },
    {
      "x": 2980,
      "y": 2250,
      "width": 1880,
      "height": 20,
      "roomId": 3
    },
    {
      "x": 2030,
      "y": 1447.5,
      "width": 20,
      "height": 495,
      "roomId": 3
    },
    {
      "x": 2030,
      "y": 1992.5,
      "width": 20,
      "height": 495,
      "roomId": 3
    },
    {
      "x": 3930,
      "y": 1720,
      "width": 20,
      "height": 1040,
      "roomId": 3
    },
    {
      "x": 960,
      "y": 1190,
      "width": 1880,
      "height": 20,
      "roomId": 4
    },
    {
      "x": 960,
      "y": 2250,
      "width": 1880,
      "height": 20,
      "roomId": 4
    },
    {
      "x": 10,
      "y": 1447.5,
      "width": 20,
      "height": 495,
      "roomId": 4
    },
    {
      "x": 10,
      "y": 1992.5,
      "width": 20,
      "height": 495,
      "roomId": 4
    },
    {
      "x": 1910,
      "y": 1447.5,
      "width": 20,
      "height": 495,
      "roomId": 4
    },
    {
      "x": 1910,
      "y": 1992.5,
      "width": 20,
      "height": 495,
      "roomId": 4
    },
    {
      "x": -1060,
      "y": 1190,
      "width": 1880,
      "height": 20,
      "roomId": 5
    },
    {
      "x": -1542.5,
      "y": 2250,
      "width": 915,
      "height": 20,
      "roomId": 5
    },
    {
      "x": -577.5,
      "y": 2250,
      "width": 915,
      "height": 20,
      "roomId": 5
    },
    {
      "x": -2010,
      "y": 1720,
      "width": 20,
      "height": 1040,
      "roomId": 5
    },
    {
      "x": -110,
      "y": 1447.5,
      "width": 20,
      "height": 495,
      "roomId": 5
    },
    {
      "x": -110,
      "y": 1992.5,
      "width": 20,
      "height": 495,
      "roomId": 5
    },
    {
      "x": -1542.5,
      "y": 2370,
      "width": 915,
      "height": 20,
      "roomId": 6
    },
    {
      "x": -577.5,
      "y": 2370,
      "width": 915,
      "height": 20,
      "roomId": 6
    },
    {
      "x": -1542.5,
      "y": 3430,
      "width": 915,
      "height": 20,
      "roomId": 6
    },
    {
      "x": -577.5,
      "y": 3430,
      "width": 915,
      "height": 20,
      "roomId": 6
    },
    {
      "x": -2010,
      "y": 2900,
      "width": 20,
      "height": 1040,
      "roomId": 6
    },
    {
      "x": -110,
      "y": 2900,
      "width": 20,
      "height": 1040,
      "roomId": 6
    },
    {
      "x": -1782.5,
      "y": 3550,
      "width": 1395,
      "height": 20,
      "roomId": 7
    },
    {
      "x": -337.5,
      "y": 3550,
      "width": 1395,
      "height": 20,
      "roomId": 7
    },
    {
      "x": -1060,
      "y": 5150,
      "width": 2840,
      "height": 20,
      "roomId": 7
    },
    {
      "x": -2490,
      "y": 3942.5,
      "width": 20,
      "height": 765,
      "roomId": 7
    },
    {
      "x": -2490,
      "y": 4757.5,
      "width": 20,
      "height": 765,
      "roomId": 7
    },
    {
      "x": 370,
      "y": 4350,
      "width": 20,
      "height": 1580,
      "roomId": 7
    },
    {
      "x": -4762.5,
      "y": 3550,
      "width": 1395,
      "height": 20,
      "roomId": 8
    },
    {
      "x": -3317.5,
      "y": 3550,
      "width": 1395,
      "height": 20,
      "roomId": 8
    },
    {
      "x": -4040,
      "y": 5150,
      "width": 2840,
      "height": 20,
      "roomId": 8
    },
    {
      "x": -5470,
      "y": 4350,
      "width": 20,
      "height": 1580,
      "roomId": 8
    },
    {
      "x": -2610,
      "y": 3942.5,
      "width": 20,
      "height": 765,
      "roomId": 8
    },
    {
      "x": -2610,
      "y": 4757.5,
      "width": 20,
      "height": 765,
      "roomId": 8
    },
    {
      "x": -4378.5,
      "y": 2694,
      "width": 627,
      "height": 20,
      "roomId": 9
    },
    {
      "x": -3701.5,
      "y": 2694,
      "width": 627,
      "height": 20,
      "roomId": 9
    },
    {
      "x": -4378.5,
      "y": 3430,
      "width": 627,
      "height": 20,
      "roomId": 9
    },
    {
      "x": -3701.5,
      "y": 3430,
      "width": 627,
      "height": 20,
      "roomId": 9
    },
    {
      "x": -4702,
      "y": 3062,
      "width": 20,
      "height": 716,
      "roomId": 9
    },
    {
      "x": -3378,
      "y": 3062,
      "width": 20,
      "height": 716,
      "roomId": 9
    },
    {
      "x": -4040,
      "y": 1838,
      "width": 1304,
      "height": 20,
      "roomId": 10
    },
    {
      "x": -4378.5,
      "y": 2574,
      "width": 627,
      "height": 20,
      "roomId": 10
    },
    {
      "x": -3701.5,
      "y": 2574,
      "width": 627,
      "height": 20,
      "roomId": 10
    },
    {
      "x": -4702,
      "y": 2014.5,
      "width": 20,
      "height": 333,
      "roomId": 10
    },
    {
      "x": -4702,
      "y": 2397.5,
      "width": 20,
      "height": 333,
      "roomId": 10
    },
    {
      "x": -3378,
      "y": 2206,
      "width": 20,
      "height": 716,
      "roomId": 10
    },
    {
      "x": -5484,
      "y": 1838,
      "width": 1304,
      "height": 20,
      "roomId": 11
    },
    {
      "x": -5484,
      "y": 2574,
      "width": 1304,
      "height": 20,
      "roomId": 11
    },
    {
      "x": -6146,
      "y": 2014.5,
      "width": 20,
      "height": 333,
      "roomId": 11
    },
    {
      "x": -6146,
      "y": 2397.5,
      "width": 20,
      "height": 333,
      "roomId": 11
    },
    {
      "x": -4822,
      "y": 2014.5,
      "width": 20,
      "height": 333,
      "roomId": 11
    },
    {
      "x": -4822,
      "y": 2397.5,
      "width": 20,
      "height": 333,
      "roomId": 11
    },
    {
      "x": -7696,
      "y": 1406,
      "width": 2840,
      "height": 20,
      "roomId": 12
    },
    {
      "x": -7696,
      "y": 3006,
      "width": 2840,
      "height": 20,
      "roomId": 12
    },
    {
      "x": -9126,
      "y": 2206,
      "width": 20,
      "height": 1580,
      "roomId": 12
    },
    {
      "x": -6266,
      "y": 1798.5,
      "width": 20,
      "height": 765,
      "roomId": 12
    },
    {
      "x": -6266,
      "y": 2613.5,
      "width": 20,
      "height": 765,
      "roomId": 12
    },
    {
      "x": 1970,
      "y": 505,
      "width": 100,
      "height": 20,
      "tunnelRooms": [
        1,
        2
      ]
    },
    {
      "x": 1970,
      "y": 575,
      "width": 100,
      "height": 20,
      "tunnelRooms": [
        1,
        2
      ]
    },
    {
      "x": 2945,
      "y": 1130,
      "width": 20,
      "height": 100,
      "tunnelRooms": [
        2,
        3
      ]
    },
    {
      "x": 3015,
      "y": 1130,
      "width": 20,
      "height": 100,
      "tunnelRooms": [
        2,
        3
      ]
    },
    {
      "x": 1970,
      "y": 1685,
      "width": 100,
      "height": 20,
      "tunnelRooms": [
        3,
        4
      ]
    },
    {
      "x": 1970,
      "y": 1755,
      "width": 100,
      "height": 20,
      "tunnelRooms": [
        3,
        4
      ]
    },
    {
      "x": -50,
      "y": 1685,
      "width": 100,
      "height": 20,
      "tunnelRooms": [
        4,
        5
      ]
    },
    {
      "x": -50,
      "y": 1755,
      "width": 100,
      "height": 20,
      "tunnelRooms": [
        4,
        5
      ]
    },
    {
      "x": -1095,
      "y": 2310,
      "width": 20,
      "height": 100,
      "tunnelRooms": [
        5,
        6
      ]
    },
    {
      "x": -1025,
      "y": 2310,
      "width": 20,
      "height": 100,
      "tunnelRooms": [
        5,
        6
      ]
    },
    {
      "x": -1095,
      "y": 3490,
      "width": 20,
      "height": 100,
      "tunnelRooms": [
        6,
        7
      ]
    },
    {
      "x": -1025,
      "y": 3490,
      "width": 20,
      "height": 100,
      "tunnelRooms": [
        6,
        7
      ]
    },
    {
      "x": -2550,
      "y": 4315,
      "width": 100,
      "height": 20,
      "tunnelRooms": [
        7,
        8
      ]
    },
    {
      "x": -2550,
      "y": 4385,
      "width": 100,
      "height": 20,
      "tunnelRooms": [
        7,
        8
      ]
    },
    {
      "x": -4075,
      "y": 3490,
      "width": 20,
      "height": 100,
      "tunnelRooms": [
        8,
        9
      ]
    },
    {
      "x": -4005,
      "y": 3490,
      "width": 20,
      "height": 100,
      "tunnelRooms": [
        8,
        9
      ]
    },
    {
      "x": -4075,
      "y": 2634,
      "width": 20,
      "height": 100,
      "tunnelRooms": [
        9,
        10
      ]
    },
    {
      "x": -4005,
      "y": 2634,
      "width": 20,
      "height": 100,
      "tunnelRooms": [
        9,
        10
      ]
    },
    {
      "x": -4762,
      "y": 2171,
      "width": 100,
      "height": 20,
      "tunnelRooms": [
        10,
        11
      ]
    },
    {
      "x": -4762,
      "y": 2241,
      "width": 100,
      "height": 20,
      "tunnelRooms": [
        10,
        11
      ]
    },
    {
      "x": -6206,
      "y": 2171,
      "width": 100,
      "height": 20,
      "tunnelRooms": [
        11,
        12
      ]
    },
    {
      "x": -6206,
      "y": 2241,
      "width": 100,
      "height": 20,
      "tunnelRooms": [
        11,
        12
      ]
    }
  ],
  "waves": [
    {
      "number": 1,
      "seconds": 10,
      "enemies": [
        {
          "type": "Squid",
          "x": 350.196522104338,
          "y": 343.98722474780385,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 1
        },
        {
          "type": "Normal",
          "x": 809.5623124306189,
          "y": 461.515955341038,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 1
        },
        {
          "type": "Normal",
          "x": 1401.7369417551652,
          "y": 716.375922392109,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 1
        }
      ]
    },
    {
      "number": 2,
      "seconds": 10,
      "enemies": [
        {
          "type": "Squid",
          "x": 2605.713278417367,
          "y": 575.4918771552996,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 2
        },
        {
          "type": "Normal",
          "x": 3650.5013569116727,
          "y": 296.6065648962275,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 2
        },
        {
          "type": "Normal",
          "x": 3448.1125595475874,
          "y": 761.351210695239,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 2
        },
        {
          "type": "Normal",
          "x": 3148.2773041933865,
          "y": 476.5077181087481,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 2
        },
        {
          "type": "Normal",
          "x": 2728.507946697505,
          "y": 146.6889372191271,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 2
        },
        {
          "type": "Normal",
          "x": 2331.2262333531885,
          "y": 266.62303936080747,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 2
        },
        {
          "type": "Normal",
          "x": 2331.2262333531885,
          "y": 911.2688383723395,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 2
        }
      ]
    },
    {
      "number": 5,
      "seconds": 10,
      "enemies": [
        {
          "type": "Mimic",
          "x": -1182.6593925653356,
          "y": 1611.2098451632748,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 5
        },
        {
          "type": "Mimic",
          "x": -207.0837501021208,
          "y": 2019.0324497995368,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 5
        }
      ]
    },
    {
      "number": 4,
      "seconds": 10,
      "enemies": [
        {
          "type": "Mimic",
          "x": 312.69015776762444,
          "y": 1771.1402783539659,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 4
        },
        {
          "type": "Mimic",
          "x": 1432.2031901024604,
          "y": 1683.1785400990857,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 4
        }
      ]
    },
    {
      "number": 3,
      "seconds": 10,
      "enemies": [
        {
          "type": "Mimic",
          "x": 2271.8379643535877,
          "y": 1691.1750617586204,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 3
        },
        {
          "type": "Mimic",
          "x": 3079.4866519665766,
          "y": 1779.1368000135003,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 3
        },
        {
          "type": "Normal",
          "x": 3418.1290340121664,
          "y": 1585.8981629192915,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 3
        },
        {
          "type": "Normal",
          "x": 2728.507946697505,
          "y": 1533.4269932323064,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 3
        },
        {
          "type": "Normal",
          "x": 2706.0203025459396,
          "y": 1765.7993161318122,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 3
        },
        {
          "type": "Normal",
          "x": 2608.573844555824,
          "y": 1990.6757576474631,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 3
        }
      ]
    },
    {
      "number": 6,
      "seconds": 10,
      "enemies": [
        {
          "type": "Mimic",
          "x": -958.7567860983677,
          "y": 2802.691572433922,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 6
        },
        {
          "type": "Mimic",
          "x": -1526.50982392532,
          "y": 2938.632440646009,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 6
        }
      ]
    },
    {
      "number": 7,
      "seconds": 10,
      "enemies": [
        {
          "type": "Mimic",
          "x": -1818.4263437541495,
          "y": 4175.321152058169,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 7
        },
        {
          "type": "Mimic",
          "x": -283.09418512351726,
          "y": 4279.275933632118,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 7
        }
      ]
    },
    {
      "number": 8,
      "seconds": 10,
      "enemies": [
        {
          "type": "Mimic",
          "x": -3665.622847106629,
          "y": 4423.21332350374,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 8
        },
        {
          "type": "Mimic",
          "x": -5128.98631080145,
          "y": 4399.223758525137,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 8
        }
      ]
    },
    {
      "number": 9,
      "seconds": 10,
      "enemies": [
        {
          "type": "Mimic",
          "x": -4121.424581700097,
          "y": 3095.7907280210065,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 9
        },
        {
          "type": "Mimic",
          "x": -3617.6437171494217,
          "y": 3063.804641382868,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 9
        }
      ]
    },
    {
      "number": 10,
      "seconds": 10,
      "enemies": [
        {
          "type": "Mimic",
          "x": -3622.0332912815525,
          "y": 2221.470720698184,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 10
        },
        {
          "type": "Mimic",
          "x": -4181.78980744897,
          "y": 2229.4672423577185,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 10
        }
      ]
    },
    {
      "number": 11,
      "seconds": 10,
      "enemies": [
        {
          "type": "Mimic",
          "x": -5325.29240476241,
          "y": 2133.5089824433044,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 11
        },
        {
          "type": "Mimic",
          "x": -5781.09413935588,
          "y": 2189.484634060046,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 11
        }
      ]
    },
    {
      "number": 12,
      "seconds": 10,
      "enemies": [
        {
          "type": "Normal",
          "x": -6632.499394346439,
          "y": 1578.9874516549087,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6708.987862542825,
          "y": 2086.592740594568,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6674.220376999013,
          "y": 2441.221093141453,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7640.756475116994,
          "y": 2719.3609774919505,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8996.688411325673,
          "y": 2510.7560642290773,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8426.501648407151,
          "y": 1766.731873591495,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8690.734538540124,
          "y": 1697.1969025038704,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8732.455521192698,
          "y": 1697.1969025038704,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8732.455521192698,
          "y": 2093.54623770333,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8725.502024083937,
          "y": 2100.499734812093,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8649.01355588755,
          "y": 2260.430168313629,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8558.618093473639,
          "y": 2469.0350815765028,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8301.338700449427,
          "y": 2503.8025671203145,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7856.31488548863,
          "y": 2260.430168313629,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7626.849480899469,
          "y": 2044.871757941993,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7724.198440422143,
          "y": 1843.2203417878818,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7863.268382597392,
          "y": 1822.3598504615945,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8099.687284295315,
          "y": 1982.290283963131,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8030.152313207691,
          "y": 2017.0577695069433,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7453.012053180407,
          "y": 2295.1976538574413,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7439.105058962882,
          "y": 2364.732624945066,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7334.802602331446,
          "y": 2427.3140989239278,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7195.732660156197,
          "y": 1912.7553128755064,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7376.523584984021,
          "y": 1572.0339545461463,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7557.314509811845,
          "y": 1704.150399612633,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6757.662342304162,
          "y": 2065.7322492682806,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6778.52283363045,
          "y": 2302.1511509662037,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6952.36026134951,
          "y": 2510.7560642290773,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7098.3837006335225,
          "y": 2670.686497730614,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7376.523584984021,
          "y": 2635.9190121868014,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7974.524336337591,
          "y": 2573.3375382079394,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8322.199191775713,
          "y": 2608.1050237517516,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8662.920550105075,
          "y": 2253.4766712048663,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8697.688035648887,
          "y": 1975.3367868543685,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7056.6627179809475,
          "y": 2030.9647637244682,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7056.6627179809475,
          "y": 2065.7322492682806,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7710.291446204618,
          "y": 2079.6392434858053,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8176.175752491702,
          "y": 1641.568925633771,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8231.803729361802,
          "y": 1641.568925633771,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8350.013180210764,
          "y": 1836.2668446791197,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8350.013180210764,
          "y": 2121.36022613838,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7891.082371032442,
          "y": 2378.639619162591,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7306.988613896396,
          "y": 2149.17421457343,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7167.918671721147,
          "y": 2170.034705899717,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6917.592775805699,
          "y": 2726.3144746007133,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6708.987862542825,
          "y": 2601.151526642989,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6750.7088451954,
          "y": 1954.4762955280812,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6924.546272914461,
          "y": 1704.150399612633,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7411.291070527833,
          "y": 1801.4993591353073,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8197.03624381799,
          "y": 2190.8951972260047,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8516.897110821063,
          "y": 2413.4071047064026,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8906.29294891176,
          "y": 1912.7553128755064,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8906.29294891176,
          "y": 1871.0343302229319,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8739.409018301461,
          "y": 2441.221093141453,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8739.409018301461,
          "y": 2552.477046881652,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8231.803729361802,
          "y": 2656.779503513089,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7487.7795387242195,
          "y": 2482.9420757940275,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7300.035116787633,
          "y": 2503.8025671203145,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7063.616215089711,
          "y": 2156.127711682192,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7035.80222665466,
          "y": 2163.081208790955,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6959.313758458273,
          "y": 2329.9651394012535,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6896.732284479412,
          "y": 2580.291035316702,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6841.104307609311,
          "y": 2670.686497730614,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6743.755348086637,
          "y": 2684.5934919481388,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6514.289943497477,
          "y": 2482.9420757940275,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6465.61546373614,
          "y": 2253.4766712048663,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6479.522457953663,
          "y": 1961.4297926368438,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6549.057429041289,
          "y": 1801.4993591353073,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7084.476706415998,
          "y": 1565.080457437384,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7515.59352715927,
          "y": 1592.8944458724338,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7988.431330555117,
          "y": 1857.127336005407,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8350.013180210764,
          "y": 2156.127711682192,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8350.013180210764,
          "y": 2156.127711682192,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8586.432081908686,
          "y": 2329.9651394012535,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8913.246446020523,
          "y": 2608.1050237517516,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -9031.455896869484,
          "y": 2204.8021914435294,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8899.339451802998,
          "y": 1850.1738388966444,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8899.339451802998,
          "y": 1578.9874516549087,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8245.710723579326,
          "y": 1648.5224227425333,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7466.919047397932,
          "y": 1745.8713822652078,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7279.174625461346,
          "y": 2058.778752159518,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7174.87216882991,
          "y": 2482.9420757940275,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6875.871793153124,
          "y": 2538.570052664127,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6743.755348086637,
          "y": 2608.1050237517516,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6618.592400128913,
          "y": 2705.4539832744263,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6576.871417476338,
          "y": 2747.174965927001,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7397.384076310308,
          "y": 2635.9190121868014,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7758.965925965956,
          "y": 2434.2675960326906,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7918.8963594674915,
          "y": 2587.2445324254645,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8113.59427851284,
          "y": 2642.8725092955638,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8322.199191775713,
          "y": 2670.686497730614,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8516.897110821063,
          "y": 2691.546989056901,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8621.199567452499,
          "y": 2788.8959485795754,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8732.455521192698,
          "y": 2705.4539832744263,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8941.060434455572,
          "y": 2309.1046480749665,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8871.525463367949,
          "y": 1905.8018157667439,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8482.12962527725,
          "y": 1676.3364111775832,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7786.779914401005,
          "y": 1780.63886780902,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7578.175001138132,
          "y": 1787.5923649177823,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7001.034741110848,
          "y": 1752.82487937397,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7001.034741110848,
          "y": 1766.731873591495,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6827.197313391786,
          "y": 1676.3364111775832,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -6778.52283363045,
          "y": 1558.1269603286214,
          "delay": 0,
          "placement": "right_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7515.59352715927,
          "y": 1530.3129718935718,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7898.035868141204,
          "y": 1530.3129718935718,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -7939.756850793779,
          "y": 1544.2199661110965,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8461.269133950964,
          "y": 1599.847942981196,
          "delay": 0,
          "placement": "random",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8683.78104143136,
          "y": 1738.9178851564452,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8662.920550105075,
          "y": 2156.127711682192,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        },
        {
          "type": "Normal",
          "x": -8593.38557901745,
          "y": 2406.4536075976407,
          "delay": 0,
          "placement": "left_edge",
          "count": 1,
          "roomId": 12
        }
      ]
    }
  ]
})



    // --- Create the Player ---
    const playerBodyDesc = RAPIER.RigidBodyDesc.dynamic()
      .setTranslation(worldWidth / 2, worldHeight / 2)
      .setCcdEnabled(true);
    const playerBody = physicsWorld.createRigidBody(playerBodyDesc);
    const playerColliderDesc = RAPIER.ColliderDesc.ball(playerRadius);
    physicsWorld.createCollider(playerColliderDesc, playerBody);
    playerBody.userData = { type: "player" };

    // Enemy spawn loop using a game plan.
    import gamePlan from "./waves/gamePlan.js";
    const triggeredWaves = new Set();
    let gameStartTime = performance.now();
    const waveSpawner = setInterval(() => {
      if (gameStarted && !document.hidden) {
        const elapsedSeconds = Math.floor((performance.now() - gameStartTime) / 1000);
        if (gamePlan.hasOwnProperty(elapsedSeconds.toString()) && !triggeredWaves.has(elapsedSeconds)) {
          triggeredWaves.add(elapsedSeconds);
          const wave = gamePlan[elapsedSeconds.toString()];
          wave.enemies.forEach(group => {
            for (let i = 0; i < group.count; i++) {
              setTimeout(() => {
                spawnGenericEnemy({
                  type: group.type,
                  physicsWorld,
                  playerBody,
                  worldWidth,
                  worldHeight,
                  enemyRadius,
                  enemies
                });
              }, group.delay * i);
            }
          });
        }
      }
    }, 1000);

    // --- Input Handling ---
    const keys = { w: false, a: false, s: false, d: false };
    let cameraMode = "full"; // "follow" or "full"
    let transitioning = false;
    let transitionStartTime = 0;
    const transitionDuration = 500;
    let transitionStartOrigin = { x: 0, y: 0 };
    let lastPlayerPos = playerBody.translation();
    let lastScale = canvas.width / worldWidth;
    window.addEventListener("keydown", (e) => {
      if (e.key === "w") keys.w = true;
      if (e.key === "a") keys.a = true;
      if (e.key === "s") keys.s = true;
      if (e.key === "d") keys.d = true;
      if (e.code === "Space") {
        dashTriggered = true;
        e.preventDefault();
      }
      if (e.key === "c") {
        transitionStartOrigin = getCameraOrigin_transition(lastPlayerPos, lastScale);
        cameraMode = (cameraMode === "follow") ? "full" : "follow";
        transitioning = true;
        transitionStartTime = performance.now();
      }
    });
    window.addEventListener("keyup", (e) => {
      if (e.key === "w") keys.w = false;
      if (e.key === "a") keys.a = false;
      if (e.key === "s") keys.s = false;
      if (e.key === "d") keys.d = false;
    });
    let lastMouseX = 0;
    let lastMouseY = 0;
    let canvasRect = canvas.getBoundingClientRect();
    window.addEventListener("resize", () => {
      canvasRect = canvas.getBoundingClientRect();
    });
    canvas.addEventListener("mousemove", (e) => {
      lastMouseX = (e.clientX - canvasRect.left) * (canvas.width / canvasRect.width);
      lastMouseY = (e.clientY - canvasRect.top) * (canvas.height / canvasRect.height);
    });
    canvas.addEventListener("mousedown", (e) => {
      if (e.button === 0) {
        isShooting = true;
      } else if (e.button === 2) {
        dashTriggered = true;
        e.preventDefault();
      }
    });
    canvas.addEventListener("mouseup", () => { isShooting = false; });
    canvas.addEventListener("mouseleave", () => { isShooting = false; });
    canvas.addEventListener("contextmenu", (e) => { e.preventDefault(); });

    // --- Camera Setup ---
    function getCameraScale() {
      return canvas.width / worldWidth;
    }
    function getCameraOrigin_follow(playerPos, scale) {
      return {
        x: canvas.width / 2 - playerPos.x * scale,
        y: canvas.height / 2 - playerPos.y * scale,
      };
    }
    function getCameraOrigin_full(playerPos, scale) {
      const viewWidth = canvas.width / scale;
      const viewHeight = canvas.height / scale;
      let camX = playerPos.x - viewWidth / 2;
      let camY = playerPos.y - viewHeight / 2;
      const margin = 10;
      camX = Math.max(-margin, Math.min(camX, worldWidth - viewWidth + margin));
      camY = Math.max(-margin, Math.min(camY, worldHeight - viewHeight + margin));
      return {
        x: -camX * scale,
        y: -camY * scale
      };
    }
    function getCameraOrigin_transition(playerPos, scale) {
      if (!transitioning) {
        return (cameraMode === "follow")
          ? getCameraOrigin_follow(playerPos, scale)
          : getCameraOrigin_full(playerPos, scale);
      }
      const currentTime = performance.now();
      let progress = (currentTime - transitionStartTime) / transitionDuration;
      if (progress >= 1) {
        transitioning = false;
        return (cameraMode === "follow")
          ? getCameraOrigin_follow(playerPos, scale)
          : getCameraOrigin_full(playerPos, scale);
      }
      const targetOrigin = (cameraMode === "follow")
        ? getCameraOrigin_follow(playerPos, scale)
        : getCameraOrigin_full(playerPos, scale);
      return {
        x: transitionStartOrigin.x + (targetOrigin.x - transitionStartOrigin.x) * progress,
        y: transitionStartOrigin.y + (targetOrigin.y - transitionStartOrigin.y) * progress,
      };
    }
    const getCameraOrigin = getCameraOrigin_transition;

    // --- Revised Movement Logic for the Player ---
    const movementLerp = 0.2;

    function updatePlayerMovement(dt) {
      const now = performance.now();

      // If a dash is triggered, update dash time and set dash velocity.
      if (dashTriggered && dashesLeft > 0) {
        lastDashTime = now;
        dashesLeft -= 1;
        // Optionally set a flag for visual effects:
        isDashing = true;
        const playerPos = playerBody.translation();
        const scale = getCameraScale();
        const origin = getCameraOrigin(playerPos, scale);
        const worldMouseX = (lastMouseX - origin.x) / scale;
        const worldMouseY = (lastMouseY - origin.y) / scale;
        const dx = worldMouseX - playerPos.x;
        const dy = worldMouseY - playerPos.y;
        const len = Math.hypot(dx, dy);
        if (len > 0) {
          const normX = dx / len;
          const normY = dy / len;
          const dashSpeed = 5000;
          playerBody.setLinvel({ x: normX * dashSpeed, y: normY * dashSpeed }, true);
        }
        dashTriggered = false;
        return;
      }

      // While within the dash period, do not update movement with WASD.
      if (now - lastDashTime < dashDuration) {
        // return;
      } else {
        isDashing = false;
      }

      // Normal movement update via WASD (only applied outside the dash period).
      const currentVel = playerBody.linvel();
      let targetVel = { x: 0, y: 0 };
      if (keys.w || keys.a || keys.s || keys.d) {
        let inputX = 0, inputY = 0;
        if (keys.w) inputY -= 1;
        if (keys.s) inputY += 1;
        if (keys.a) inputX -= 1;
        if (keys.d) inputX += 1;
        const len = Math.hypot(inputX, inputY);
        if (len > 0) {
          inputX /= len;
          inputY /= len;
        }
        targetVel.x = inputX * maxPlayerSpeed;
        targetVel.y = inputY * maxPlayerSpeed;
      }
      const newVel = {
        x: currentVel.x + (targetVel.x - currentVel.x) * movementLerp,
        y: currentVel.y + (targetVel.y - currentVel.y) * movementLerp,
      };
      playerBody.setLinvel(newVel, true);
    }

    // --- Collision Handling ---
    function handleCollision(handle1, handle2) {
      const collider1 = physicsWorld.getCollider(handle1);
      const collider2 = physicsWorld.getCollider(handle2);
      if (!collider1 || !collider2) return;
      const body1 = collider1.parent();
      const body2 = collider2.parent();
      if (!body1 || !body2) return;
      const type1 = body1.userData ? body1.userData.type : null;
      const type2 = body2.userData ? body2.userData.type : null;

      // Define all enemy types and power-up types.
      const enemyTypes = ["enemy_bullet", "normal", "squid", "triangle", "boring", "gunner", "mimic"];
      const powerUpTypes = ["health", "dash", "multiBullet", "bulletSpeed", "fireRate", "bulletUpgrade", "powerGlow", "special"];

      // Bullet colliding with an enemy.
      if (
        (type1 === "bullet" && enemyTypes.includes(type2)) ||
        (type2 === "bullet" && enemyTypes.includes(type1))
      ) {
        let bullet, target;
        if (type1 === "bullet") {
          bullet = body1;
          target = body2;
        } else {
          bullet = body2;
          target = body1;
        }
        const pos = target.translation();
        // Accumulate 1 damage per collision.
        target.userData.damageAccumulated = (target.userData.damageAccumulated || 0) + 1;
        if (target.userData.damageAccumulated >= target.userData.health) {
          if (target.userData.type != "enemy_bullet")
            startBubbleExplosion(pos.x, pos.y);
          target.userData.shouldRemove = true;
        }
        bullet.shouldRemove = true;
        bullet.userData.shouldRemove = true;
        score += 10;
        return;
      }

      // Player colliding with an enemy.
      if (
        (type1 === "player" && enemyTypes.includes(type2)) ||
        (type2 === "player" && enemyTypes.includes(type1))
      ) {
        const player = type1 === "player" ? body1 : body2;
        const enemy = player === body1 ? body2 : body1;
        const pos = enemy.translation();
        startBubbleExplosion(pos.x, pos.y);
        if (!isDashing) {
          playerHealth -= 10;
          startDamageExplosion(player.translation().x, player.translation().y);
        }
        // Accumulate damage on the enemy.
        enemy.userData.damageAccumulated = (enemy.userData.damageAccumulated || 0) + 1;
        if (enemy.userData.damageAccumulated >= enemy.userData.health) {
          enemy.userData.shouldRemove = true;
        }
        if (playerHealth <= 0) {
          endGame();
        }
        return;
      }

      // Player colliding with a power-up.
      if (
        (type1 === "player" && powerUpTypes.includes(type2)) ||
        (type2 === "player" && powerUpTypes.includes(type1))
      ) {
        const player = type1 === "player" ? body1 : body2;
        const powerUp = player === body1 ? body2 : body1;
        const powerType = powerUp.userData.type;
        if (powerType === "health") {
          // Increase player's health by 10.
          playerHealth += 10;
        } else if (powerType == "dash") {
          // Handle other power-ups (you can add more behavior here).
          dashesLeft += 10;
        }
        else {
          // Handle other power-ups (you can add more behavior here).
          console.log(`Picked up power-up: ${powerType}`);
        }
        // Remove the power-up.
        powerUp.userData.shouldRemove = true;
        return;
      }
      // --- Handle enemy bullet collisions (including walls) ---
      if (type1 === "enemy_bullet" || type2 === "enemy_bullet") {
        const now = performance.now();
        let enemyBulletBody, otherType;
        if (type1 === "enemy_bullet") {
          enemyBulletBody = body1;
          otherType = type2; // could be null if colliding with a wall
        } else {
          enemyBulletBody = body2;
          otherType = type1;
        }
        // If colliding with a wall (or any object without a defined type), remove immediately.
        if (otherType === null || otherType === "wall" || enemyTypes.includes(otherType)) {
          enemyBulletBody.shouldRemove = true;
          if (enemyBulletBody.userData) enemyBulletBody.userData.shouldRemove = true;
          return;
        }
        // For collisions with dynamic objects, use a grace period.
        const birthTime = enemyBulletBody.userData.birthTime || now;
        const gracePeriod = 0; // milliseconds; adjust as needed.
        if (now - birthTime > gracePeriod) {
          enemyBulletBody.shouldRemove = true;
          if (enemyBulletBody.userData) enemyBulletBody.userData.shouldRemove = true;
          // If the enemy bullet hit the player, apply damage.
          if (otherType === "player") {
            if (!isDashing) {
              playerHealth -= 10;
              startDamageExplosion(playerBody.translation().x, playerBody.translation().y);
            }
            if (playerHealth <= 0) {
              endGame();
            }
          }
        }
        return;
      }
    }

    // --- Modal and Game Start/Restart Logic ---
    let gameStarted = false;
    const modal = document.getElementById("modal");
    const modalContent = document.getElementById("modalContent");
    const beginButton = document.getElementById("beginButton");
    beginButton.addEventListener("click", () => {
      gameStarted = true;
      modal.style.display = "none";
    });
    function endGame() {
      gameStarted = false;
      // Track high score in local storage.
      let highScore = parseInt(localStorage.getItem("highScore") || "0", 10);
      if (score > highScore) {
        highScore = score;
        localStorage.setItem("highScore", highScore);
      }
      modalContent.innerHTML = `
          <h1>Game Over</h1>
          <p>Your Score: ${score}</p>
          <p>High Score: ${highScore}</p>
          <button id="playAgain">Play Again</button>
        `;
      document.getElementById("playAgain").addEventListener("click", () => {
        location.reload();
      });
      modal.style.display = "flex";
    }

    // --- Fullscreen Button Functionality ---
    document.getElementById("fullscreenButton").addEventListener("click", () => {
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen();
      } else if (document.documentElement.webkitRequestFullscreen) {
        document.documentElement.webkitRequestFullscreen();
      } else if (document.documentElement.msRequestFullscreen) {
        document.documentElement.msRequestFullscreen();
      }
    });

    // --- Function to create a bullet ---
    function createBullet(timestamp, bulletCount = 1, offsetAngleDegrees = 0, randomnessDegrees = 0) {
      // Calculate bullet angle offsets.
      let offsets = [];
      if (bulletCount === 1) {
        offsets.push(0);
      } else {
        const offsetAngleRad = offsetAngleDegrees * Math.PI / 180;
        const halfCount = (bulletCount - 1) / 2;
        for (let i = 0; i < bulletCount; i++) {
          let offset = (i - halfCount) * offsetAngleRad;
          offsets.push(offset);
        }
      }

      const playerPos = playerBody.translation();
      const shipAngle = playerBody.rotation();
      const gunOffset = playerRadius + 10;

      offsets.forEach((angleOffset) => {
        // Add randomness if randomnessDegrees is not 0.
        let randomOffset = 0;
        if (randomnessDegrees !== 0) {
          randomOffset = (Math.random() * 2 - 1) * (randomnessDegrees * Math.PI / 180);
        }
        // Calculate the final angle with the base shipAngle, offset, and randomness.
        const angle = shipAngle + angleOffset + randomOffset;
        const bulletStartX = playerPos.x + Math.cos(angle) * gunOffset;
        const bulletStartY = playerPos.y + Math.sin(angle) * gunOffset;
        const bulletBodyDesc = RAPIER.RigidBodyDesc.dynamic().setTranslation(bulletStartX, bulletStartY);
        const bulletBody = physicsWorld.createRigidBody(bulletBodyDesc);
        const bulletColliderDesc = RAPIER.ColliderDesc.ball(bulletRadius);
        physicsWorld.createCollider(bulletColliderDesc, bulletBody);

        bulletBody.setLinvel({
          x: Math.cos(angle) * bulletSpeed,
          y: Math.sin(angle) * bulletSpeed
        }, true);

        bulletBody.userData = { type: "bullet" };
        bullets.push({ body: bulletBody, birthTime: timestamp });
      });

      // Play the shooting sound once for the entire shot.
      const soundClone = shotSound.cloneNode();
      soundClone.volume = 0.02;
      soundClone.play();
    }

    // --- Game Loop ---
    let lastTime = performance.now();
    let time = 0;

    function gameLoop(currentTime) {
      // Calculate time delta in milliseconds and seconds.
      const deltaMs = currentTime - lastTime;
      const dt = deltaMs / 1000;
      lastTime = currentTime;

      if (!gameStarted) {
        gameStartTime = performance.now();
        requestAnimationFrame(gameLoop);
        return;
      }

      time += 16;
      lastPlayerPos = playerBody.translation();
      lastScale = getCameraScale();

      if (aiEnabled) {
        updateAI({
          dt,
          playerBody,
          enemies,
          bulletSpeed,
          aiLeadFactor,
          maxPlayerSpeed,
          getCameraScale,
          getCameraOrigin,
          lastMouseX,
          lastMouseY,
          isDashing,
          dashTriggered,
          setDashTriggered: (val) => { dashTriggered = val; },
          setIsDashing: (val) => { isDashing = val; },
          setIsShooting: (val) => { isShooting = val; },
          worldWidth,
          worldHeight
        });
      } else {
        updatePlayerMovement(dt);
      }

      // Use the bullet accumulator to generate the correct number of bullets.
      if (isShooting) {
        bulletAccumulator += deltaMs;
        while (bulletAccumulator >= fireInterval) {
          bulletAccumulator -= fireInterval;
          createBullet(currentTime, 1, 0, 0);
        }
      } else {
        bulletAccumulator = 0;
      }

      physicsWorld.step(eventQueue);
      eventQueue.drainCollisionEvents((handle1, handle2, started) => {
        if (started) {
          handleCollision(handle1, handle2);
        }
      });

      updateAllEnemies(enemies, playerBody, currentTime, dt, physicsWorld);

      // Remove bullets that have exceeded their lifetime or left the bounds.
      for (let i = bullets.length - 1; i >= 0; i--) {
        const bullet = bullets[i];
        if (
          bullet.body.shouldRemove ||
          currentTime - bullet.birthTime > bulletLifetime
          // ||
          // bullet.body.translation().x < 0 ||
          // bullet.body.translation().x > worldWidth ||
          // bullet.body.translation().y < 0 ||
          // bullet.body.translation().y > worldHeight
        ) {
          physicsWorld.removeRigidBody(bullet.body);
          bullets[i] = bullets[bullets.length - 1];
          bullets.pop();
        }
      }

      // Shooting: Adjust player's rotation to face the mouse cursor.
      if (lastMouseX || lastMouseY) {
        const scale = getCameraScale();
        const origin = getCameraOrigin(playerBody.translation(), scale);
        const worldMouseX = (lastMouseX - origin.x) / scale;
        const worldMouseY = (lastMouseY - origin.y) / scale;
        const targetAngle = Math.atan2(worldMouseY - playerBody.translation().y, worldMouseX - playerBody.translation().x);
        const currentAngle = playerBody.rotation();
        let angleDiff = Math.atan2(Math.sin(targetAngle - currentAngle), Math.cos(targetAngle - currentAngle));
        const angularPushFactor = 20;
        const angularVelocity = angleDiff * angularPushFactor;
        playerBody.setAngvel(angularVelocity, true);
      }

      renderScene({
        ctx,
        canvas,
        worldWidth,
        worldHeight,
        walls,
        playerBody,
        isDashing,
        playerRadius,
        enemies: enemies,
        enemyRadius,
        bullets,
        bulletRadius,
        getCameraScale,
        getCameraOrigin,
        updateBubbleExplosions,
        updateDamageExplosions,
        time
      });

      // Update HUD to show Health, Score, and Dashes remaining.
      document.getElementById("healthDiv").innerText = "Health: " + playerHealth + "% | Score: " + score + " | Dashes: " + dashesLeft;
      requestAnimationFrame(gameLoop);
    }
    requestAnimationFrame(gameLoop);
  </script>
</body>

</html>